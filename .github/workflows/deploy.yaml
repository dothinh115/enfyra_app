name: Deploy to VPS
on:
  push:
    branches: [main]

jobs:
  # Cleanup BEFORE deploy to prevent disk buildup
  pre-cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Pre-deployment Cleanup
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "=== Pre-deployment cleanup (safe) ==="
            
            # Get current running image to preserve
            CURRENT_IMAGE=$(kubectl get deployment enfyra-cms-deployment -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "none")
            echo "Current running image: $CURRENT_IMAGE"
            
            # Remove old Docker images (keep current + latest)
            docker images enfyra-cms --format "{{.Repository}}:{{.Tag}}" | grep -v latest | while read img; do
              if [ "$img" != "$CURRENT_IMAGE" ]; then
                echo "Removing old Docker image: $img"
                docker rmi -f "$img" || true
              fi
            done
            
            # Clean old registry images (but preserve current)
            microk8s ctr images list -q | grep "localhost:32000/enfyra-cms:" | while read img; do
              if [ "$img" != "$CURRENT_IMAGE" ]; then
                echo "Removing old registry image: $img"  
                microk8s ctr images remove "$img" || true
              fi
            done
            
            # Safe cleanup cycles (only unused content)
            for i in {1..3}; do
              echo "Safe cleanup cycle $i"
              microk8s ctr content prune references || true
              docker image prune -f || true
            done
            
            echo "Pre-cleanup completed"
            df -h /

  deploy:
    runs-on: ubuntu-latest
    needs: pre-cleanup
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            # Set project variables
            export PROJECT_NAME="enfyra-cms"
            export APP_DIR="/apps/$PROJECT_NAME"
            export DEPLOYMENT_DIR="/deployments/$PROJECT_NAME"
            
            # Update source code
            cd $APP_DIR
            git reset --hard HEAD
            git clean -fd
            git pull origin main
            export IMAGE_TAG=$(git rev-parse --short HEAD)
            
            # Build with timeout and retry
            echo "Building Docker image $PROJECT_NAME:$IMAGE_TAG..."
            if ! timeout 600 docker build -t $PROJECT_NAME:$IMAGE_TAG . ; then
              echo "Build failed or timed out, retrying..."
              docker system prune -f || true
              timeout 600 docker build -t $PROJECT_NAME:$IMAGE_TAG . || exit 1
            fi
            
            # Verify build success
            if ! docker images $PROJECT_NAME:$IMAGE_TAG | grep -q $IMAGE_TAG; then
              echo "ERROR: Docker image build failed!"
              exit 1
            fi
            
            echo "Build completed successfully"
            
            # Detect K8s mode early
            export K8S_MODE=$(yq ".kubernetes.provider" ~/configs/$PROJECT_NAME.yaml 2>/dev/null || echo "microk8s")
            echo "K8S_MODE detected: $K8S_MODE"
            
            # Configure image for MicroK8s - Use registry for faster deployment
            if [ "$K8S_MODE" = "microk8s" ]; then
              echo "=== Pushing to local registry ==="
              
              # Enable MicroK8s registry if not enabled
              microk8s enable registry || true
              
              # Tag and push to local registry
              LOCAL_REGISTRY="localhost:32000"
              REGISTRY_IMAGE="$LOCAL_REGISTRY/$PROJECT_NAME:$IMAGE_TAG"
              
              echo "Tagging image for registry: $REGISTRY_IMAGE"
              docker tag $PROJECT_NAME:$IMAGE_TAG $REGISTRY_IMAGE
              
              echo "Pushing to MicroK8s registry..."
              if docker push $REGISTRY_IMAGE; then
                echo "✅ Image successfully pushed to registry"
                export PULUMI_IMAGE="$REGISTRY_IMAGE"
              else
                echo "❌ Failed to push to registry, falling back to import"
                docker save $PROJECT_NAME:$IMAGE_TAG | microk8s ctr image import -
                export PULUMI_IMAGE="$PROJECT_NAME:$IMAGE_TAG"
              fi
              
              echo "=== MicroK8s image ready ==="
            fi

            # Setup Kubernetes config
            cd $DEPLOYMENT_DIR

            if [ "$K8S_MODE" = "microk8s" ]; then
              echo "Using MicroK8s configuration"
              export KUBECONFIG=/var/snap/microk8s/current/credentials/client.config
            else
              echo "Using kubeadm configuration"
              export KUBECONFIG=/etc/kubernetes/admin.conf
            fi

            # Setup Pulumi environment
            export PATH=$PATH:$HOME/.pulumi/bin
            export PULUMI_CONFIG_PASSPHRASE=''

            # Run Pulumi deployment with new image tag
            pulumi version
            pulumi login file://$(pwd)/.pulumi
            pulumi stack select $PROJECT_NAME
            
            # Clear any existing locks
            pulumi cancel || true
            
            pulumi config set image ${PULUMI_IMAGE:-$PROJECT_NAME:$IMAGE_TAG}
            pulumi up --yes
            
            echo "=== Deployment completed successfully ==="

