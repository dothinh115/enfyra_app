<template>
  <div class="space-y-6">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-300">User Manager</h1>
    </div>
    <Transition name="loading-fade" mode="out-in">
      <CommonLoadingState
        v-if="!isMounted || loading"
        title="Loading users..."
        description="Fetching user accounts"
        size="sm"
        type="card"
        context="page"
      />

      <div
        v-else-if="users.length > 0"
        class="grid gap-4"
        :class="
          isTablet
            ? 'grid-cols-1 lg:grid-cols-2'
            : 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'
        "
      >
        <CommonSettingsCard
          v-for="user in users"
          :key="user.id"
          :title="user.name || user.email || 'Unnamed User'"
          :description="user.email || 'No email'"
          icon="lucide:user"
          icon-color="primary"
          :card-class="'cursor-pointer hover:ring-2 hover:ring-primary/20 transition-all'"
          @click="navigateTo(`/settings/users/${user.id}`)"
          :stats="[
            {
              label: 'Role',
              component: user.role ? 'UBadge' : null,
              props: user.role
                ? {
                    variant: 'soft',
                    color: 'primary',
                  }
                : undefined,
              value: user.role?.name || 'No role',
            },
            {
              label: 'Joined',
              value: new Date(user.createdAt).toLocaleDateString(),
            },
          ]"
          :actions="[]"
          :header-actions="getHeaderActions(user)"
        />
      </div>

      <CommonEmptyState
        v-else
        title="No users found"
        description="No user accounts have been created yet"
        icon="lucide:users"
        size="sm"
      />
    </Transition>

    <div class="flex justify-center mt-4" v-if="!loading && users.length > 0">
      <UPagination
        v-model="page"
        :page-count="limit"
        :total="total"
        size="sm"
        v-if="total > limit"
      />
    </div>

    <FilterDrawerLazy
      v-model="showFilterDrawer"
      :filter-value="currentFilter"
      :table-name="tableName"
      @apply="applyFilters"
      @clear="clearFilters"
    />
  </div>
</template>
<script setup lang="ts">
const page = ref(1);
const limit = 9;
const tableName = "user_definition";
const { confirm } = useConfirm();
const { getIncludeFields } = useSchema(tableName);
const { createEmptyFilter, buildQuery, hasActiveFilters } = useFilterQuery();

const { isMounted } = useMounted();
const { isTablet } = useScreen();

const showFilterDrawer = ref(false);
const currentFilter = ref(createEmptyFilter());
const toast = useToast();

const {
  data: apiData,
  pending: loading,
  execute: fetchUsers,
} = useApiLazy(() => `/${tableName}`, {
  query: computed(() => {
    const filterQuery = hasActiveFilters(currentFilter.value)
      ? buildQuery(currentFilter.value)
      : {};

    return {
      limit,
      page: page.value,
      fields: getIncludeFields(),
      meta: "*",
      ...(Object.keys(filterQuery).length > 0 && { filter: filterQuery }),
    };
  }),
  errorContext: "Fetch Users",
});

const users = computed(() => apiData.value?.data || []);
const total = computed(() => apiData.value?.meta?.totalCount || 0);

const filterLabel = computed(() => {
  const activeCount = currentFilter.value.conditions.length;
  return activeCount > 0 ? `Filters (${activeCount})` : "Filter";
});

const filterVariant = computed(() => {
  return hasActiveFilters(currentFilter.value) ? "solid" : "outline";
});

const filterColor = computed(() => {
  return hasActiveFilters(currentFilter.value) ? "secondary" : "neutral";
});

useHeaderActionRegistry([
  {
    id: "filter-users",
    get label() {
      return filterLabel.value;
    },
    icon: "lucide:filter",
    get variant() {
      return filterVariant.value;
    },
    get color() {
      return filterColor.value;
    },
    size: "md",
    onClick: () => {
      showFilterDrawer.value = true;
    },
    permission: {
      and: [
        {
          route: `/${tableName}`,
          actions: ["read"],
        },
      ],
    },
  },
  {
    id: "create-user",
    label: "Create User",
    icon: "lucide:plus",
    variant: "solid",
    color: "primary",
    size: "md",
    to: "/settings/users/create",
    permission: {
      and: [
        {
          route: `/${tableName}`,
          actions: ["create"],
        },
      ],
    },
  },
]);

async function applyFilters() {
  page.value = 1;
  await fetchUsers();
}

function clearFilters() {
  currentFilter.value = createEmptyFilter();
  applyFilters();
}

function getHeaderActions(user: any) {
  const actions = [];

  // Avatar
  if (user.avatar) {
    actions.push({
      component: "UAvatar",
      props: {
        src: user.avatar,
        alt: user.name,
        size: "xs",
      },
    });
  } else {
    actions.push({
      component: "UAvatar",
      props: {
        alt: user.name,
        size: "xs",
      },
      label: user.email?.charAt(0)?.toUpperCase() || "?",
    });
  }

  // Delete button
  if (!user.isRootAdmin) {
    actions.push({
      component: "UButton",
      props: {
        icon: "i-heroicons-trash",
        variant: "outline",
        color: "error",
      },
      onClick: (e?: Event) => {
        e?.stopPropagation();
        deleteUser(user);
      },
    });
  }

  return actions;
}

async function deleteUser(user: any) {
  // Protect rootAdmin from deletion
  if (user.isRootAdmin) {
    toast.add({
      title: "Error",
      description: "Cannot delete root administrator account",
      color: "error",
    });
    return;
  }

  const isConfirmed = await confirm({
    title: "Delete User",
    content: `Are you sure you want to delete user "${
      user.name || user.email
    }"? This action cannot be undone.`,
    confirmText: "Delete",
    cancelText: "Cancel",
  });

  if (isConfirmed) {
    const { execute: deleteUserApi, error: deleteError } = useApiLazy(
      () => `/${tableName}/${user.id}`,
      {
        method: "delete",
        errorContext: "Delete User",
      }
    );

    await deleteUserApi();

    if (deleteError.value) {
      return;
    }

    await fetchUsers();

    toast.add({
      title: "Success",
      description: `User "${
        user.name || user.email
      }" has been deleted successfully!`,
      color: "success",
    });
  }
}

watch(
  apiData,
  (newData) => {
    if (newData?.data) {
    }
  },
  { immediate: true }
);

onMounted(async () => {
  await fetchUsers();
});
</script>
